<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KAVA BulkSender</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        body { padding-top: 50px; }
    </style>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/3.0.0-rc.5/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        let CONTRACT, ACCOUNT;
        const ethEnabled = async () => {
            if (window.ethereum) {
                await window.ethereum.send('eth_requestAccounts');
                window.web3 = new Web3(window.ethereum);
                const account = await window.web3.eth.getAccounts();
                const jsonInterface = [
                    {
                        "inputs": [],
                        "name": "FailedToSendValue",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "InvalidAmount",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "InvalidRecipient",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "InvalidRecipients",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "InvalidToken",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "NotEnoughApproval",
                        "type": "error"
                    },
                    {
                        "inputs": [],
                        "name": "NotEnoughBalance",
                        "type": "error"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address[]",
                                "name": "recipients",
                                "type": "address[]"
                            },
                            {
                                "internalType": "uint256[]",
                                "name": "amount",
                                "type": "uint256[]"
                            }
                        ],
                        "name": "sendKavaToMany",
                        "outputs": [],
                        "stateMutability": "payable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "contract IERC20",
                                "name": "token",
                                "type": "address"
                            },
                            {
                                "internalType": "address[]",
                                "name": "recipients",
                                "type": "address[]"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amount",
                                "type": "uint256"
                            }
                        ],
                        "name": "sendSameAmountToMany",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address[]",
                                "name": "recipients",
                                "type": "address[]"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amount",
                                "type": "uint256"
                            }
                        ],
                        "name": "sendSameAmountToManyInFee",
                        "outputs": [],
                        "stateMutability": "payable",
                        "type": "function"
                    }
                ];
                const contractAddress = '0x65e21BF68a90eead2e935D8774A171c189F5e940';
                ACCOUNT = account[0];
                CONTRACT = new window.web3.eth.Contract(jsonInterface, contractAddress );
                $('#result').html('connected.');
                return true;
            }
            $('#result').html("no metamask support");
            return false;
        }
        function splitAndClean(str){
            let arr = str.split(RegExp(/[^a-zA-Z\d]/));
            let array = []
            for (let i in arr) {
                if (!arr[i]) continue;
                array.push(arr[i].trimEnd().trimStart());
            }
            return array;
        }
        //
        function sendSameAmountToManyInFee(valueInDecimal, addressesText){
            let addressesArray = splitAndClean(addressesText);
            let valueInWei = web3.utils.toWei(valueInDecimal);
            const total = parseFloat(valueInDecimal) * addressesArray.length;
            const totalInWei = web3.utils.toWei(total.toString());
            try {
                const args = {from: ACCOUNT, value: totalInWei};
                CONTRACT.methods.sendSameAmountToManyInFee(addressesArray, valueInWei).estimateGas(args,
                    async function(error, gasAmount){
                        if( error ){
                            alert.html( error.toString() );
                        }else{
                            const tx = await CONTRACT.methods.sendSameAmountToManyInFee(addressesArray, valueInWei).send(args);
                            $( "#result" ).html( tx );
                        }
                    });
            } catch (e) {
                alert(e.toString());
            }
        }

        function sendKavaToMany(valuesInDecimal, addressesText, isWei){
            let addressesArray = splitAndClean(addressesText);
            let valuesArray = splitAndClean(valuesInDecimal);
            let totalInDecimal = 0;
            let valuesInWei = [];
            for( let i in valuesArray ) {
                totalInDecimal += parseFloat(valuesArray[i]);
                if( ! isWei ) {
                    valuesInWei.push(web3.utils.toWei(valuesArray[i]));
                }else{
                    valuesInWei.push(valuesArray[i]);
                }
            }
            //
            if( addressesArray.length !== valuesArray.length ){
                alert( `Error: addresses=${addressesArray.length}, values=${valuesArray.length}` );
                return;
            }
            const totalInWei = web3.utils.toWei(totalInDecimal.toString());
            try {
                const args = {from: ACCOUNT, value: totalInWei};
                CONTRACT.methods.sendKavaToMany(addressesArray, valuesInWei).estimateGas(args,
                    async function(error, gasAmount){
                        if( error ){
                            alert( error.toString() );
                        }else{
                            const tx = await CONTRACT.methods.sendKavaToMany(addressesArray, valuesInWei).send(args);
                            $( "#result" ).html( tx );
                        }
                    });
            } catch (e) {
                alert(e.toString());
            }
        }

        async function main(){
            await ethEnabled();
        }


    </script>
</head>
<body onload="main()">

<div class="container">
    <div id="result"></div>
    <div class="jumbotron">
        <h1>Send same amount of KAVA to many wallets...</h1>
        <hr/>
        <p>
            KAVA same value in decimal for each user:
            <input type="number" id="sendSameToManyInKava_value"/>
            <input type="button" value="Send"
                   onclick="sendSameAmountToManyInFee($('#sendSameToManyInKava_value').val(), $('#sendSameToManyInKava_addresses').val())" />
            <br/>
        </p>
        <p>
        <textarea rows="8" cols="100%" id="sendSameToManyInKava_addresses"
        placeholder="0x1,0x2,0x3"></textarea>
        </p>
    </div>


    <hr/>

    <div class="jumbotron">
        <h1>Send individual amount of KAVA to many wallets...</h1>
        <hr/>
        <p>
            KAVA individual value in decimal for each user:
            <textarea rows="8" cols="100%" id="sendKavaToMany_values"
                      placeholder="0.1,0.2,1"></textarea>
        </p>
        <hr/>
        <p>
        <textarea rows="8" cols="100%" id="sendKavaToMany_addresses"
                  placeholder="0x1,0x2,0x3"></textarea>
        </p>
        <hr>

        <input type="button" value="Send as Decimal"
               onclick="sendKavaToMany($('#sendKavaToMany_values').val(), $('#sendKavaToMany_addresses').val(), false)" />

        <input type="button" value="Send as Wei"
               onclick="sendKavaToMany($('#sendKavaToMany_values').val(), $('#sendKavaToMany_addresses').val(), true)" />


    </div>


</div>

</body>
</html>
